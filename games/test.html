<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TurboWarp Cloud Example</title>
<style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #score { font-size: 48px; margin-bottom: 20px; }
    button { font-size: 24px; padding: 10px 20px; cursor: pointer; }
</style>
</head>
<body>

<h1 id="score">Score : ...</h1>
<button id="btn">+1</button>

<script>
// ---------------------------------------------------------------
// CONFIGURATION DU PROJET
// ---------------------------------------------------------------

// Adresse du serveur Cloud TurboWarp
const CLOUD_SERVER = "wss://clouddata.turbowarp.org";

// L'ID du projet : doit exister dans TurboWarp / Scratch
const PROJECT_ID = "p4-@Projet.sb3";

// Nom EXACT de la variable cloud
const CLOUD_VAR = "score";

// Pseudo obligatoire, peut être n'importe quoi
const USERNAME = "WebClient_1";


// ---------------------------------------------------------------
// 1. OUVERTURE DE LA CONNEXION WEBSOCKET
// ---------------------------------------------------------------
let ws = new WebSocket(CLOUD_SERVER);

ws.onopen = () => {
    console.log("Connected to Cloud Server.");

    // Le serveur demande toujours une "handshake"
    ws.send(JSON.stringify({ method: "handshake" }));
};


// ---------------------------------------------------------------
// 2. RECEPTION DES MESSAGES DU SERVEUR CLOUD
// ---------------------------------------------------------------
ws.onmessage = (event) => {

    // Le serveur peut envoyer plusieurs JSON dans un seul message
    const lines = event.data.split("\n");

    for (const line of lines) {
        if (!line) continue;

        let data;
        try { data = JSON.parse(line); }
        catch (e) { continue; }

        // Nous nous intéressons uniquement aux mises à jour
        if (data.method === "set" && data.name === CLOUD_VAR) {
            console.log("Cloud updated:", data);

            document.getElementById("score").innerText =
                "Score : " + data.value;
        }
    }
};


// ---------------------------------------------------------------
// 3. ENVOYER UNE MISE À JOUR AU SERVEUR
// ---------------------------------------------------------------
function setCloudValue(name, value) {
    const msg = {
        method: "set",
        name: name,
        value: String(value),  // Doit être une chaîne
        project_id: PROJECT_ID,
        user: USERNAME
    };

    ws.send(JSON.stringify(msg));
}


// ---------------------------------------------------------------
// 4. AJOUTER +1 AU SCORE
// ---------------------------------------------------------------
document.getElementById("btn").onclick = () => {

    const txt = document.getElementById("score").innerText;
    let current = parseInt(txt.replace("Score : ", "")) || 0;

    const newValue = current + 1;

    // Envoyer au cloud
    setCloudValue(CLOUD_VAR, newValue);
};
</script>

</body>
</html>
