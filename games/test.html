<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TurboWarp Cloud Example</title>
<style>
    body { 
        font-family: Arial; 
        text-align: center; 
        margin-top: 40px; 
        background: #f0f0f0;
    }
    #score { 
        font-size: 48px; 
        margin-bottom: 20px; 
        color: #333;
    }
    button { 
        font-size: 24px; 
        padding: 10px 20px; 
        cursor: pointer;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
    }
    button:hover { background: #45a049; }
    #status {
        margin-top: 20px;
        font-size: 14px;
        color: #666;
    }
</style>
</head>
<body>
<h1 id="score">Score : ...</h1>
<button id="btn">+1</button>
<div id="status">Connexion en cours...</div>

<script>
// ---------------------------------------------------------------
// CONFIGURATION DU PROJET
// ---------------------------------------------------------------
const CLOUD_SERVER = "wss://clouddata.turbowarp.org";

// ‚ö†Ô∏è REMPLACEZ PAR VOTRE VRAI ID DE PROJET (num√©rique uniquement)
// Exemple: "1234567890" - Trouvez-le dans l'URL de votre projet
const PROJECT_ID = "1234567890";  // ‚Üê CHANGEZ CECI !

// ‚ö†Ô∏è Le nom doit inclure le symbole ‚òÅ
// Si votre variable s'appelle "score" dans Scratch, utilisez "‚òÅ score"
const CLOUD_VAR = "‚òÅ score";  // ‚Üê V√©rifiez le nom exact !

const USERNAME = "WebClient_" + Math.floor(Math.random() * 10000);

// ---------------------------------------------------------------
// VARIABLES LOCALES
// ---------------------------------------------------------------
let ws;
let currentScore = 0;
let isConnected = false;

// ---------------------------------------------------------------
// 1. OUVERTURE DE LA CONNEXION WEBSOCKET
// ---------------------------------------------------------------
function connect() {
    ws = new WebSocket(CLOUD_SERVER);
    
    ws.onopen = () => {
        console.log("‚úÖ Connect√© au serveur Cloud");
        document.getElementById("status").innerText = "Connect√© au Cloud";
        
        // Handshake requis
        const handshake = JSON.stringify({
            method: "handshake",
            project_id: PROJECT_ID,
            user: USERNAME
        });
        ws.send(handshake);
        
        isConnected = true;
    };
    
    // ---------------------------------------------------------------
    // 2. RECEPTION DES MESSAGES
    // ---------------------------------------------------------------
    ws.onmessage = (event) => {
        const lines = event.data.split("\n");
        
        for (const line of lines) {
            if (!line.trim()) continue;
            
            let data;
            try { 
                data = JSON.parse(line); 
            } catch (e) { 
                console.error("Erreur parsing JSON:", e);
                continue; 
            }
            
            console.log("Message re√ßu:", data);
            
            // Mise √† jour de la variable cloud
            if (data.method === "set" && data.name === CLOUD_VAR) {
                currentScore = parseInt(data.value) || 0;
                document.getElementById("score").innerText = "Score : " + currentScore;
                console.log("‚úÖ Score mis √† jour:", currentScore);
            }
        }
    };
    
    ws.onerror = (error) => {
        console.error("‚ùå Erreur WebSocket:", error);
        document.getElementById("status").innerText = "Erreur de connexion";
    };
    
    ws.onclose = () => {
        console.log("‚ö†Ô∏è Connexion ferm√©e");
        document.getElementById("status").innerText = "D√©connect√© - Reconnexion...";
        isConnected = false;
        
        // Tentative de reconnexion apr√®s 3 secondes
        setTimeout(connect, 3000);
    };
}

// ---------------------------------------------------------------
// 3. ENVOYER UNE MISE √Ä JOUR
// ---------------------------------------------------------------
function setCloudValue(value) {
    if (!isConnected || ws.readyState !== WebSocket.OPEN) {
        console.warn("‚ö†Ô∏è WebSocket pas connect√©");
        document.getElementById("status").innerText = "Non connect√© - En attente...";
        return;
    }
    
    const msg = JSON.stringify({
        method: "set",
        name: CLOUD_VAR,
        value: String(value),
        project_id: PROJECT_ID,
        user: USERNAME
    });
    
    console.log("üì§ Envoi:", msg);
    ws.send(msg);
}

// ---------------------------------------------------------------
// 4. BOUTON +1
// ---------------------------------------------------------------
document.getElementById("btn").onclick = () => {
    const newScore = currentScore + 1;
    
    // Mise √† jour locale imm√©diate (pour r√©activit√©)
    currentScore = newScore;
    document.getElementById("score").innerText = "Score : " + currentScore;
    
    // Envoi au cloud
    setCloudValue(newScore);
};

// ---------------------------------------------------------------
// 5. D√âMARRAGE
// ---------------------------------------------------------------
connect();
</script>
</body>
</html>
